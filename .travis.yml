sudo: required
language: java
jdk:
  - openjdk11
services:
  - docker
before_install:
  - openssl aes-256-cbc -K $encrypted_d039a0754913_key -iv $encrypted_d039a0754913_iv
    -in travis/helseci.key.enc -out travis/helseci.key -d
  - git clone https://github.com/navikt/github-apps-support.git
  - export PATH=`pwd`/github-apps-support/bin:$PATH
  - export GH_TOKEN=$(generate-installation-token.sh `generate-jwt.sh ./travis/helseci.key
    $GITHUB_APP_ID`)
  - export COMMIT_SHORT=$(git rev-parse --short HEAD)
  - export ORIGINAL_COMMITTER=$(git log -1 --pretty=format:'%an <%ae>')
  - echo -e "machine github.com\n  login $GH_TOKEN" > ~/.netrc
script:
  - "./gradlew check jar"
  - docker build --pull -t $DOCKER_IMG_NAME:$COMMIT_SHORT .
  - |
    set -e
    if [ "${TRAVIS_PULL_REQUEST}" = "false" ] && [ "${TRAVIS_BRANCH}" = "master" ]; then
      echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin
      docker push $DOCKER_IMG_NAME:$COMMIT_SHORT

      git clone https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git

      cd helse-iac
      ./set-image.sh preprod/$APP_NAME/naiserator-sbs.yaml $DOCKER_IMG_NAME:$COMMIT_SHORT

      git config user.name team-helse[bot]
      git config user.email team-helse[bot]@users.noreply.github.com

      git add preprod/$APP_NAME/naiserator-sbs.yaml
      git commit -m "Bump $APP_NAME" -m "Caused by $TRAVIS_BUILD_WEB_URL" --author "$ORIGINAL_COMMITTER"

      git push https://x-access-token:$GH_TOKEN@github.com/navikt/helse-iac.git master

      cd ..
      fi
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  directories:
    - "$HOME/.gradle/caches/"
    - "$HOME/.gradle/wrapper/"
env:
  global:
    - APP_NAME=pleiepengesoknad-api
    - DOCKER_IMG_NAME=navikt/pleiepengesoknad-api
    - GITHUB_APP_ID=19726
    - secure: RpUT0gVAHj7W3esWbJVru689avQZMJcUlDkd987xv20Pts0XMTjZufcDkuz1XD1ye09Fz3+XqwF65+vJLAx3hPfgfbrlfj68YW/7c81pH5z+8bU0UEmCbo3znZ2FMaPMAvKFtcXG0Vt18dkCXDlYAjfVz6b1xqqiJdRpcsJcZlLeKZJqq+1S+wFNZh7nysW2jO8BNSyWLMcJxnjY1hhWBvCf0nff9TmUtQ8BWyuRIxHbKXS8jCdONNw9bHwfAB5U96K38Scy+WshLurg13PA42QqXnVFSaoFBEsQ5Z6rpji7QyLtqUuHQWVxtxkpVL6WzFxSRofV2KrFPYv69RZTmN8yMHhGAsjW9fZedffiShnQz167SEZ5ZSdZs5O2X6rD2H9TiReSf7yDvvQzP62rB7VXTn1iPhZXxxLZsgxDQQQBo1Hlp3gImVfFDPLnLCsvzyfEcSppo62O94sgRNWWWv6Ai/uSK7m3+yBUBNjpvvJAmcBwQD7yrNdaOlZikeHWrlyKR7aESuaW7vG/xRpEH0rhEKZl6GF3oXqP4es3u+lhftlCU5qGye5Rk+uZMy0ad8aub5ZC17nAvzNRv45zQ/QKRIt40mxf4cL0WkUA+8dfb22zIYNr/YbLxDCKM44eWWBO0lH0SvQ++bGGf6tLvpIRo+ckWzqIQ5E2zS++xMs=
    - secure: G4oYAAR/7BqtzOZqfZXyxYFIG6XxoYsv4ZEMN2R8ZX+D5hNQWNJ3Mss0mbuNaSguzlsRAL+hDpPYiqsIkDGhL4/qID8IYrSTjuPZ445N9vy7J8i5EIRWVWH/Sifs2c/m0KX/2XBzLR2f7oOBnSkg8WTwxnQA1Um1Hv+v11itbBzXPdZDJCHIn1hZXkc0hB05IlGSJkOxo1pzWx2NvvcBfvmPLii4bFJKnKhTkOEF3ntmmLsJNRYfWOHWesrMl3v+F+yFGABnh5/9+k2FAGi7gXT12Y9XH4RpwpB9/tESLdTLUkmwduh++JrdXSi9lAmqjeDl/zJcLc3gEYDTcxZSNUI5esw1XwVd/H76M4ppmvZqNHiXD321a5ZIwv0zbaWTF9nZlei4OVPbTZkxPNTffa9nBhT5WmVtuDSy3UvF3SNyZ17/qzyrfKkyDPuXDALeNM7Q+SEAK9Gc2a4iN9VcSu7jDMQ1Ni6hGu4XVE/d1RYXfZ3hSSToiqYkTFlaqP5P3pIZue5pkAA1+SFGEGx/hXL7zOmDPL8RRuMUQB2cU2IGkQXBgnKAIMsyZHq4paO1rRdl1vVS6cI/URC4SFnzLCmgD9Z5APC/2hW4I+bZg4C4x8IZgU1aYKJzy6dP1rSBMgCD5ylvDrzITxaRdxPeCJpcIDQRlbUtZqRPoFl07KI=